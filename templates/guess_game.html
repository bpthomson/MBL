<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .game-wrapper {
            max-width: 560px;
            width: 90%;
            margin: 60px auto;
            background-color: #1a1a1a;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid #2a2a2a;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .header-section {
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        h1 { color: #e0e0e0; font-size: 1.4em; font-weight: 500; margin: 0; letter-spacing: 1px; }
        p#status { font-size: 0.85em; color: #888; margin: 0; font-family: monospace; transition: color 0.3s; }
        
        .error-message { color: #ff453a !important; }
        .correct-message { color: #32d74b !important; }

        audio { width: 100%; height: 36px; margin-bottom: 25px; outline: none; border-radius: 4px; opacity: 0.8; transition: 0.2s; }
        audio:hover { opacity: 1; }
        
        .controls-group { margin-bottom: 20px; }
        .controls-group p { margin: 0 0 8px 0; font-size: 0.75em; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .controls-container { display: flex; gap: 8px; }
        .controls-container button { 
            padding: 8px 0; font-size: 0.85em; cursor: pointer; 
            border: 1px solid #333; border-radius: 4px; 
            background-color: #222; color: #aaa; transition: all 0.2s;
            flex: 1; font-family: monospace;
        }
        .controls-container button:hover:not(:disabled) { background-color: #333; color: #fff; border-color: #555; }
        .controls-container button:disabled { opacity: 0.3; cursor: not-allowed; }

        #answer-inputs-container { display: flex; flex-direction: column; gap: 10px; margin: 30px 0; }
        #answer-inputs-container input { 
            margin: 0; padding: 12px 16px; border-radius: 4px; border: 1px solid #333; 
            background-color: #111; color: #e0e0e0; font-size: 0.95em;
            transition: 0.2s; outline: none; width: 100%; box-sizing: border-box;
        }
        #answer-inputs-container input:focus { border-color: #0071e3; background-color: #151515; }
        #answer-inputs-container input.correct { border-color: #32d74b; color: #32d74b; }
        #answer-inputs-container input.incorrect { border-color: #ff453a; color: #ff453a; }

        .main-actions { display: flex; gap: 10px; }
        .main-actions button { 
            flex: 1; padding: 10px 0; font-size: 0.9em; border-radius: 4px; font-weight: 500; 
            border: none; cursor: pointer; transition: 0.2s;
        }
        #submit-guess-btn { background-color: #0071e3; color: #fff; }
        #submit-guess-btn:hover:not(:disabled) { background-color: #005bb5; }
        #reveal-btn { background-color: #2a2a2a; color: #ccc; border: 1px solid #444; }
        #reveal-btn:hover:not(:disabled) { background-color: #333; color: #fff; }
        #next-song-btn { background-color: #333; color: #fff; }
        #next-song-btn:hover:not(:disabled) { background-color: #444; }

        #answer-section { 
            display: none; margin-top: 30px; padding-top: 25px; border-top: 1px solid #2a2a2a; 
            animation: fadeIn 0.3s ease-out; text-align: left;
        }
        #anime-title { color: #fff; font-size: 1.1em; font-weight: 500; margin: 0 0 4px 0; }
        #song-info { color: #888; font-size: 0.85em; margin: 0; font-family: monospace; }
        #anime-cover { width: 100%; max-height: 200px; object-fit: cover; border-radius: 4px; margin-top: 15px; border: 1px solid #333; }
        #video-player { width: 100%; border-radius: 4px; margin-top: 15px; display: none; outline: none; background: #000; }
        
        .footer-link { margin-top: 30px; text-align: center; }
        .footer-link a { color: #555; text-decoration: none; font-size: 0.8em; transition: 0.2s; }
        .footer-link a:hover { color: #aaa; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div class="header-section">
            <h1>Audio Quiz</h1>
            <p id="status">Initializing...</p>
        </div>

        <audio id="audio-player" controls></audio>

        <div class="controls-group">
            <p>Standard Playback</p>
            <div class="controls-container">
                <button class="play-btn" data-sec="1" data-type="normal">1.0s</button>
                <button class="play-btn" data-sec="3" data-type="normal">3.0s</button>
                <button class="play-btn" data-sec="10" data-type="normal">10.0s</button>
            </div>
        </div>

        <div class="controls-group">
            <p>Random Playback</p>
            <div class="controls-container">
                <button class="play-btn" data-sec="1" data-type="random">1.0s</button>
                <button class="play-btn" data-sec="3" data-type="random">3.0s</button>
                <button class="play-btn" data-sec="10" data-type="random">10.0s</button>
            </div>
        </div>

        <div id="answer-inputs-container">
            <input type="text" id="guess-name" placeholder="Title" list="anime-titles-list" autocomplete="off">
            <datalist id="anime-titles-list"></datalist>
            <input type="text" id="guess-type" placeholder="Type (e.g. OP1)" autocomplete="off">
            <input type="text" id="guess-year" placeholder="Year" autocomplete="off">
        </div>

        <div class="main-actions">
            <button id="submit-guess-btn">Submit</button>
            <button id="reveal-btn">Reveal</button>
            <button id="next-song-btn">Next</button>
        </div>

        <div id="answer-section">
            <h2 id="anime-title"></h2>
            <p id="song-info"></p>
            <video id="video-player" controls></video>
            <img id="anime-cover" src="" alt="Cover">
        </div>
        
        <div class="footer-link">
            <a href="/">Return</a>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const gamePlaylist = {{ playlist | safe }};
        
        const statusEl = document.getElementById('status');
        const audioPlayerEl = document.getElementById('audio-player');
        const videoPlayerEl = document.getElementById('video-player');
        const revealBtn = document.getElementById('reveal-btn');
        const nextSongBtn = document.getElementById('next-song-btn');
        const answerSection = document.getElementById('answer-section');
        const animeTitleEl = document.getElementById('anime-title');
        const songInfoEl = document.getElementById('song-info');
        const animeCoverEl = document.getElementById('anime-cover');
        
        const guessNameInput = document.getElementById('guess-name');
        const guessTypeInput = document.getElementById('guess-type');
        const guessYearInput = document.getElementById('guess-year');
        const submitGuessBtn = document.getElementById('submit-guess-btn');
        const answerInputs = [guessNameInput, guessTypeInput, guessYearInput];
        const playBtns = document.querySelectorAll('.play-btn');
        
        let currentSong = null, nextSong = null, isPreloading = false, playbackTimeout;
        let isAnswerRevealed = false;

        const datalist = document.getElementById('anime-titles-list');
        const uniqueTitles = [...new Set(gamePlaylist.map(item => item.anime_ch_name))];
        uniqueTitles.forEach(title => {
            const option = document.createElement('option');
            option.value = title;
            datalist.appendChild(option);
        });

        function setStatus(message, isError = false, isCorrect = false) {
            statusEl.textContent = message;
            statusEl.className = '';
            if (isError) statusEl.classList.add('error-message');
            if (isCorrect) statusEl.classList.add('correct-message');
        }

        async function preloadNextSong() {
            if (isPreloading || gamePlaylist.length === 0) return;
            isPreloading = true;
            try {
                const metadata = gamePlaylist[Math.floor(Math.random() * gamePlaylist.length)];
                const proxyUrl = `/api/audio-proxy?url=${encodeURIComponent(metadata.theme_link)}`;
                const audioResponse = await fetch(proxyUrl);
                if (!audioResponse.ok) throw new Error('Fetch failed');
                const audioBlob = await audioResponse.blob();
                nextSong = { metadata, audioBlobUrl: URL.createObjectURL(audioBlob) };
            } catch (error) {
                nextSong = null;
            } finally {
                isPreloading = false;
            }
        }

        async function setupNewGame() {
            isAnswerRevealed = false;
            answerSection.style.display = 'none';
            videoPlayerEl.style.display = 'none';
            videoPlayerEl.pause();
            videoPlayerEl.src = '';
            animeCoverEl.style.display = 'none';

            setStatus('Loading...');
            revealBtn.disabled = true;
            nextSongBtn.disabled = true;
            submitGuessBtn.disabled = true;
            playBtns.forEach(btn => btn.disabled = true);

            answerInputs.forEach(input => {
                input.value = '';
                input.classList.remove('correct', 'incorrect');
                input.disabled = false;
            });

            if (playbackTimeout) clearTimeout(playbackTimeout);
            if (currentSong && currentSong.audioBlobUrl) URL.revokeObjectURL(currentSong.audioBlobUrl);
            audioPlayerEl.pause();

            if (!nextSong) await preloadNextSong();
            currentSong = nextSong;
            nextSong = null;

            if (!currentSong) {
                setStatus('Error: Load failed.', true);
                nextSongBtn.disabled = false;
                return;
            }

            const preloadPromise = preloadNextSong(); 
            audioPlayerEl.src = currentSong.audioBlobUrl;
            audioPlayerEl.load();

            audioPlayerEl.oncanplaythrough = async () => {
                setStatus('Ready.');
                revealBtn.disabled = false;
                submitGuessBtn.disabled = false;
                playBtns.forEach(btn => btn.disabled = false);
                await preloadPromise;
                nextSongBtn.disabled = false;
            };

            audioPlayerEl.onerror = () => {
                setStatus('Error: Playback failed.', true);
                nextSongBtn.disabled = false;
            };
        }

        function checkAnswer() {
            if (isAnswerRevealed || !currentSong) return;
            const { metadata } = currentSong;
            let correctCount = 0;

            const nameCorrect = guessNameInput.value.trim() === metadata.anime_ch_name;
            guessNameInput.classList.toggle('correct', nameCorrect);
            guessNameInput.classList.toggle('incorrect', !nameCorrect);
            if (nameCorrect) correctCount++;

            const typeCorrect = guessTypeInput.value.trim().toUpperCase() === metadata.theme_type.toUpperCase();
            guessTypeInput.classList.toggle('correct', typeCorrect);
            guessTypeInput.classList.toggle('incorrect', !typeCorrect);
            if (typeCorrect) correctCount++;

            const yearCorrect = guessYearInput.value.trim() === String(metadata.anime_year);
            guessYearInput.classList.toggle('correct', yearCorrect);
            guessYearInput.classList.toggle('incorrect', !yearCorrect);
            if (yearCorrect) correctCount++;

            if (correctCount === 3) {
                setStatus('Match: 100%.', false, true);
                revealAnswer();
            } else {
                setStatus(`Match: ${correctCount}/3.`, correctCount === 0);
            }
        }
        
        function revealAnswer() {
            if (isAnswerRevealed || !currentSong) return;
            isAnswerRevealed = true;

            answerInputs.forEach(input => input.disabled = true);
            submitGuessBtn.disabled = true;
            revealBtn.disabled = true;
            if (playbackTimeout) clearTimeout(playbackTimeout);
            audioPlayerEl.pause();
            
            const { metadata } = currentSong;
            
            let titleText = metadata.anime_ch_name;
            if (metadata.anime_year && metadata.anime_year !== 'N/A') {
                titleText += ` (${metadata.anime_year})`;
            }
            animeTitleEl.textContent = titleText;
            
            songInfoEl.textContent = `${metadata.theme_type} : ${metadata.theme_title}`;
            
            if (metadata.video_link) {
                videoPlayerEl.src = metadata.video_link;
                videoPlayerEl.style.display = 'block';
                videoPlayerEl.play();
            } else if (metadata.anime_img_url) {
                animeCoverEl.src = metadata.anime_img_url;
                animeCoverEl.style.display = 'block';
            }
            
            answerSection.style.display = 'block';
        }

        function playAudio(seconds, isRandom) {
            if (!currentSong) return;
            if (playbackTimeout) clearTimeout(playbackTimeout);
            
            let startTime = 0;
            if (isRandom && audioPlayerEl.duration) {
                const maxStartTime = audioPlayerEl.duration - seconds;
                startTime = Math.random() * (maxStartTime > 0 ? maxStartTime : 0);
            }
            
            audioPlayerEl.currentTime = startTime;
            audioPlayerEl.play();
            playbackTimeout = setTimeout(() => audioPlayerEl.pause(), seconds * 1000);
        }

        submitGuessBtn.addEventListener('click', checkAnswer);
        revealBtn.addEventListener('click', revealAnswer);
        nextSongBtn.addEventListener('click', setupNewGame);
        
        answerInputs.forEach(input => {
            input.addEventListener('keypress', e => { if (e.key === 'Enter') checkAnswer(); });
        });

        playBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const sec = parseInt(btn.getAttribute('data-sec'));
                const isRandom = btn.getAttribute('data-type') === 'random';
                playAudio(sec, isRandom);
            });
        });

        if(gamePlaylist.length > 0) {
            setupNewGame();
        } else {
            setStatus("Error: No data.", true);
        }
    });
    </script>
</body>
</html>