<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Quiz Module</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        audio { width: 100%; height: 36px; margin-bottom: 25px; outline: none; border-radius: 4px; opacity: 0.8; transition: 0.2s; }
        audio:hover { opacity: 1; }
        
        .controls-group { margin-bottom: 18px; background: #0d1117; padding: 15px; border-radius: 6px; border: 1px solid #21262d; }
        .controls-group p { margin: 0 0 10px 0; font-size: 11px; color: #8b949e; font-family: monospace; letter-spacing: 0.5px; }
        .controls-container { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        
        #answer-inputs-container { display: flex; flex-direction: column; gap: 12px; margin: 25px 0; }
        #answer-inputs-container input { margin: 0; }
        
        .main-actions { display: flex; gap: 10px; justify-content: center; }
        .main-actions button { flex: 1; margin: 0; }

        #answer-section { display: none; margin-top: 25px; padding-top: 20px; border-top: 1px dashed #30363d; animation: fadeIn 0.4s ease-out; text-align: left;}
        #anime-cover { width: 100%; max-height: 240px; object-fit: cover; border-radius: 6px; margin-top: 15px; border: 1px solid #30363d; }
        #video-player { width: 100%; border-radius: 6px; margin-top: 15px; display: none; outline: none; background: #000; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex-center">
    <div class="navbar">
        <a href="/" class="navbar-brand">
            <span style="color: #005bb5; font-weight: bold; margin-right: 5px;">/></span>MBL System
        </a>
        
        <div class="navbar-links" style="display: flex; align-items: center; gap: 15px;">
            <span style="display: flex; align-items: center; gap: 5px; color: #3fb950; font-family: monospace; font-size: 11px;">
                <span style="width: 6px; height: 6px; background-color: #3fb950; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #3fb950;"></span>
                SYS.ONLINE
            </span>

            {% if user_id %}
            <span style="color: #8b949e; font-family: monospace; font-size: 11px; border-left: 1px solid #30363d; padding-left: 15px;">
                TARGET : <span style="color: #c9d1d9;">{{ user_id }}</span>
            </span>
            {% endif %}

            <span style="border-left: 1px solid #30363d; padding-left: 15px;">
                <a href="https://docs.google.com/spreadsheets/d/14lacBmNveOxbD461wObB9x0KW86dFY4GgsTbte8iOo8/edit" target="_blank">[ Error Logs ]</a>
            </span>
        </div>
    </div>
    <div class="wrapper">
        <div class="header-section">
            <h1>Audio Quiz Module</h1>
            <p id="status" class="sub-text">Initializing...</p>
        </div>

        <audio id="audio-player" controls></audio>

        <div class="controls-group">
            <p>> Standard Playback</p>
            <div class="controls-container">
                <button class="play-btn play-btn-1" data-sec="1" data-type="normal">1.0s</button>
                <button class="play-btn play-btn-2" data-sec="3" data-type="normal">3.0s</button>
                <button class="play-btn play-btn-3" data-sec="10" data-type="normal">10.0s</button>
            </div>
        </div>

        <div class="controls-group">
            <p>> Random Playback</p>
            <div class="controls-container">
                <button class="play-btn play-btn-1" data-sec="1" data-type="random">1.0s</button>
                <button class="play-btn play-btn-2" data-sec="3" data-type="random">3.0s</button>
                <button class="play-btn play-btn-3" data-sec="10" data-type="random">10.0s</button>
            </div>
        </div>

        <div id="answer-inputs-container">
            <input type="text" id="guess-name" placeholder="Title" list="anime-titles-list" autocomplete="off">
            <datalist id="anime-titles-list"></datalist>
            <input type="text" id="guess-type" placeholder="Type (e.g. OP1)" autocomplete="off">
            <input type="text" id="guess-year" placeholder="Year" autocomplete="off">
        </div>

        <div class="main-actions">
            <button id="submit-guess-btn" class="btn btn-primary">Verify</button>
            <button id="reveal-btn" class="btn btn-secondary">Reveal</button>
            <button id="next-song-btn" class="btn btn-success">Next Track</button>
        </div>

        <div id="answer-section">
            <h2 id="anime-title" style="color: #fff; margin: 0 0 5px 0; font-size: 16px; font-weight: 500;"></h2>
            <p id="song-info" style="color: #8b949e; margin: 0; font-family: monospace; font-size: 12px;"></p>
            <video id="video-player" controls></video>
            <img id="anime-cover" src="" alt="Cover">
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
            <a href="/select/{{user_id}}" style="color: #6e7681; text-decoration: none; font-size: 12px; font-family: monospace;">[ Return to Selection ]</a>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const gamePlaylist = {{ playlist | safe }};
        const statusEl = document.getElementById('status');
        const audioPlayerEl = document.getElementById('audio-player');
        const videoPlayerEl = document.getElementById('video-player');
        const revealBtn = document.getElementById('reveal-btn');
        const nextSongBtn = document.getElementById('next-song-btn');
        const answerSection = document.getElementById('answer-section');
        const animeTitleEl = document.getElementById('anime-title');
        const songInfoEl = document.getElementById('song-info');
        const animeCoverEl = document.getElementById('anime-cover');
        const guessNameInput = document.getElementById('guess-name');
        const guessTypeInput = document.getElementById('guess-type');
        const guessYearInput = document.getElementById('guess-year');
        const submitGuessBtn = document.getElementById('submit-guess-btn');
        const answerInputs = [guessNameInput, guessTypeInput, guessYearInput];
        const playBtns = document.querySelectorAll('.play-btn');
        let currentSong = null, nextSong = null, isPreloading = false, playbackTimeout;
        let isAnswerRevealed = false;

        const datalist = document.getElementById('anime-titles-list');
        const uniqueTitles = [...new Set(gamePlaylist.map(item => item.anime_ch_name))];
        uniqueTitles.forEach(title => {
            const option = document.createElement('option');
            option.value = title; datalist.appendChild(option);
        });

        function setStatus(message, isError = false, isCorrect = false) {
            statusEl.textContent = message; statusEl.className = 'sub-text';
            if (isError) statusEl.classList.add('text-error');
            if (isCorrect) statusEl.classList.add('text-success');
        }

        async function preloadNextSong() {
            if (isPreloading || gamePlaylist.length === 0) return;
            isPreloading = true;
            try {
                const metadata = gamePlaylist[Math.floor(Math.random() * gamePlaylist.length)];
                const proxyUrl = `/api/audio-proxy?url=${encodeURIComponent(metadata.theme_link)}`;
                const audioResponse = await fetch(proxyUrl);
                if (!audioResponse.ok) throw new Error('Fetch failed');
                const audioBlob = await audioResponse.blob();
                nextSong = { metadata, audioBlobUrl: URL.createObjectURL(audioBlob) };
            } catch (error) { nextSong = null; } finally { isPreloading = false; }
        }

        async function setupNewGame() {
            isAnswerRevealed = false; answerSection.style.display = 'none';
            videoPlayerEl.style.display = 'none'; videoPlayerEl.pause(); videoPlayerEl.src = '';
            animeCoverEl.style.display = 'none'; setStatus('Loading...');
            revealBtn.disabled = true; nextSongBtn.disabled = true; submitGuessBtn.disabled = true;
            playBtns.forEach(btn => btn.disabled = true);
            answerInputs.forEach(input => { input.value = ''; input.classList.remove('correct', 'incorrect'); input.disabled = false; });
            if (playbackTimeout) clearTimeout(playbackTimeout);
            if (currentSong && currentSong.audioBlobUrl) URL.revokeObjectURL(currentSong.audioBlobUrl);
            audioPlayerEl.pause();
            if (!nextSong) await preloadNextSong();
            currentSong = nextSong; nextSong = null;
            if (!currentSong) { setStatus('SYS_ERR: Load failed.', true); nextSongBtn.disabled = false; return; }
            const preloadPromise = preloadNextSong(); 
            audioPlayerEl.src = currentSong.audioBlobUrl; audioPlayerEl.load();
            audioPlayerEl.oncanplaythrough = async () => {
                setStatus('Ready.'); revealBtn.disabled = false; submitGuessBtn.disabled = false;
                playBtns.forEach(btn => btn.disabled = false); await preloadPromise; nextSongBtn.disabled = false;
            };
            audioPlayerEl.onerror = () => { setStatus('SYS_ERR: Playback exception.', true); nextSongBtn.disabled = false; };
        }

        function checkAnswer() {
            if (isAnswerRevealed || !currentSong) return;
            const { metadata } = currentSong; let correctCount = 0;
            const nameCorrect = guessNameInput.value.trim() === metadata.anime_ch_name;
            guessNameInput.classList.toggle('correct', nameCorrect); guessNameInput.classList.toggle('incorrect', !nameCorrect);
            if (nameCorrect) correctCount++;
            const typeCorrect = guessTypeInput.value.trim().toUpperCase() === metadata.theme_type.toUpperCase();
            guessTypeInput.classList.toggle('correct', typeCorrect); guessTypeInput.classList.toggle('incorrect', !typeCorrect);
            if (typeCorrect) correctCount++;
            const yearCorrect = guessYearInput.value.trim() === String(metadata.anime_year);
            guessYearInput.classList.toggle('correct', yearCorrect); guessYearInput.classList.toggle('incorrect', !yearCorrect);
            if (yearCorrect) correctCount++;
            if (correctCount === 3) { setStatus('Match: 100%.', false, true); revealAnswer(); } else { setStatus(`Match: ${correctCount} / 3.`, correctCount === 0); }
        }
        
        function revealAnswer() {
            if (isAnswerRevealed || !currentSong) return;
            isAnswerRevealed = true; answerInputs.forEach(input => input.disabled = true);
            submitGuessBtn.disabled = true; revealBtn.disabled = true;
            if (playbackTimeout) clearTimeout(playbackTimeout); audioPlayerEl.pause();
            const { metadata } = currentSong;
            let titleText = metadata.anime_ch_name;
            if (metadata.anime_year && metadata.anime_year !== 'N/A') { titleText += ` (${metadata.anime_year})`; }
            animeTitleEl.textContent = titleText; songInfoEl.textContent = `> ${metadata.theme_type} : ${metadata.theme_title}`;
            if (metadata.video_link) { videoPlayerEl.src = metadata.video_link; videoPlayerEl.style.display = 'block'; videoPlayerEl.play(); } else if (metadata.anime_img_url) { animeCoverEl.src = metadata.anime_img_url; animeCoverEl.style.display = 'block'; }
            answerSection.style.display = 'block';
        }

        function playAudio(seconds, isRandom) {
            if (!currentSong) return;
            if (playbackTimeout) clearTimeout(playbackTimeout);
            let startTime = 0;
            if (isRandom && audioPlayerEl.duration) { const maxStartTime = audioPlayerEl.duration - seconds; startTime = Math.random() * (maxStartTime > 0 ? maxStartTime : 0); }
            audioPlayerEl.currentTime = startTime; audioPlayerEl.play();
            playbackTimeout = setTimeout(() => audioPlayerEl.pause(), seconds * 1000);
        }

        submitGuessBtn.addEventListener('click', checkAnswer); revealBtn.addEventListener('click', revealAnswer); nextSongBtn.addEventListener('click', setupNewGame);
        answerInputs.forEach(input => { input.addEventListener('keypress', e => { if (e.key === 'Enter') checkAnswer(); }); });
        playBtns.forEach(btn => { btn.addEventListener('click', () => { const sec = parseInt(btn.getAttribute('data-sec')); const isRandom = btn.getAttribute('data-type') === 'random'; playAudio(sec, isRandom); }); });
        if(gamePlaylist.length > 0) { setupNewGame(); } else { setStatus("SYS_ERR: Missing dataset.", true); }
    });
    </script>
</body>
</html>