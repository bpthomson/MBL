<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猜猜動漫主題曲！</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* 猜歌遊戲專屬樣式 */
        .game-wrapper {
            max-width: 600px;
            width: 90%;
            margin: 40px auto;
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
            text-align: center;
            border: 1px solid #333;
        }
        h1 { color: #ff9f0a; margin-bottom: 25px; }
        p#status { font-size: 1.2em; height: 25px; color: #aaa; transition: color 0.3s; margin-bottom: 20px; }
        .error-message { color: #ff453a !important; }
        .correct-message { color: #32d74b !important; font-weight: bold; }

        audio { width: 100%; margin-bottom: 15px; outline: none; }
        
        .controls-group { margin-bottom: 20px; background: #2c2c2c; padding: 15px; border-radius: 8px; }
        .controls-group p { margin: 0 0 10px 0; font-size: 0.9em; color: #ccc; font-weight: bold; }
        .controls-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .controls-container button { 
            padding: 8px 15px; font-size: 0.9em; cursor: pointer; 
            border: 1px solid #ff9f0a; border-radius: 5px; 
            background-color: transparent; color: #ff9f0a; transition: 0.2s;
        }
        .controls-container button:hover:not(:disabled) { background-color: #ff9f0a; color: #000; }

        #answer-inputs-container { display: flex; flex-direction: column; gap: 12px; margin: 25px 0; }
        #answer-inputs-container input { 
            padding: 12px; border-radius: 6px; border: 2px solid #555; 
            background-color: #121212; color: white; font-size: 1em; text-align: center;
            transition: 0.3s; outline: none;
        }
        #answer-inputs-container input:focus { border-color: #ff9f0a; }
        #answer-inputs-container input.correct { border-color: #32d74b; }
        #answer-inputs-container input.incorrect { border-color: #ff453a; }

        .main-actions button { margin: 5px; width: calc(33% - 14px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* 答案揭曉區 */
        #answer-section { 
            display: none; margin-top: 25px; padding-top: 20px; border-top: 1px dashed #555; 
            animation: fadeIn 0.5s ease-in-out;
        }
        #anime-cover { max-width: 80%; height: auto; border-radius: 8px; margin-top: 15px; border: 2px solid #444; }
        #video-player { width: 100%; border-radius: 8px; margin-top: 15px; display: none; outline: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <h1>猜猜動漫主題曲！</h1>
        <p id="status">正在準備歌曲...</p>

        <audio id="audio-player" controls></audio>

        <div class="controls-group">
            <p>從頭播放</p>
            <div class="controls-container">
                <button class="play-btn" data-sec="1" data-type="normal">提示 1 秒</button>
                <button class="play-btn" data-sec="3" data-type="normal">提示 3 秒</button>
                <button class="play-btn" data-sec="10" data-type="normal">提示 10 秒</button>
            </div>
        </div>

        <div class="controls-group">
            <p>從隨機位置播放</p>
            <div class="controls-container">
                <button class="play-btn" data-sec="1" data-type="random">隨機 1 秒</button>
                <button class="play-btn" data-sec="3" data-type="random">隨機 3 秒</button>
                <button class="play-btn" data-sec="10" data-type="random">隨機 10 秒</button>
            </div>
        </div>

        <div id="answer-inputs-container">
            <input type="text" id="guess-name" placeholder="動漫中文名稱" list="anime-titles-list">
            <datalist id="anime-titles-list"></datalist>
            <input type="text" id="guess-type" placeholder="OP/ED 類型 (例如: OP1)">
        </div>

        <div class="main-actions controls-container">
            <button id="submit-guess-btn" class="btn btn-primary">提交答案</button>
            <button id="reveal-btn" class="btn btn-outline">揭曉答案</button>
            <button id="next-song-btn" class="btn btn-success">下一首</button>
        </div>

        <div id="answer-section">
            <h2 id="anime-title" style="color: #fff; margin-bottom: 5px;"></h2>
            <p id="song-info" style="color: #aaa; margin-top: 0;"></p>
            <video id="video-player" controls></video>
            <img id="anime-cover" src="" alt="Anime Cover">
        </div>
        
        <div style="margin-top: 30px;">
            <a href="/" style="color: #888; text-decoration: none; font-size: 14px;">返回首頁</a>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const gamePlaylist = {{ playlist | safe }};
        
        // --- DOM 元素獲取 ---
        const statusEl = document.getElementById('status');
        const audioPlayerEl = document.getElementById('audio-player');
        const videoPlayerEl = document.getElementById('video-player');
        const revealBtn = document.getElementById('reveal-btn');
        const nextSongBtn = document.getElementById('next-song-btn');
        const answerSection = document.getElementById('answer-section');
        const animeTitleEl = document.getElementById('anime-title');
        const songInfoEl = document.getElementById('song-info');
        const animeCoverEl = document.getElementById('anime-cover');
        const guessNameInput = document.getElementById('guess-name');
        const guessTypeInput = document.getElementById('guess-type');
        const submitGuessBtn = document.getElementById('submit-guess-btn');
        const answerInputs = [guessNameInput, guessTypeInput];
        const playBtns = document.querySelectorAll('.play-btn');
        
        // --- 狀態變數 ---
        let currentSong = null, nextSong = null, isPreloading = false, playbackTimeout;
        let isAnswerRevealed = false;

        // --- 初始化自動完成選單 (Datalist) ---
        const datalist = document.getElementById('anime-titles-list');
        const uniqueTitles = [...new Set(gamePlaylist.map(item => item.anime_ch_name))];
        uniqueTitles.forEach(title => {
            const option = document.createElement('option');
            option.value = title;
            datalist.appendChild(option);
        });

        // --- 功能函式 ---
        function setStatus(message, isError = false, isCorrect = false) {
            statusEl.textContent = message;
            statusEl.className = '';
            if (isError) statusEl.classList.add('error-message');
            if (isCorrect) statusEl.classList.add('correct-message');
        }

        async function preloadNextSong() {
            if (isPreloading || gamePlaylist.length === 0) return;
            isPreloading = true;
            try {
                // 隨機挑選一首
                const metadata = gamePlaylist[Math.floor(Math.random() * gamePlaylist.length)];
                const proxyUrl = `/api/audio-proxy?url=${encodeURIComponent(metadata.theme_link)}`;
                const audioResponse = await fetch(proxyUrl);
                if (!audioResponse.ok) throw new Error('音訊載入失敗');
                const audioBlob = await audioResponse.blob();
                nextSong = { metadata, audioBlobUrl: URL.createObjectURL(audioBlob) };
            } catch (error) {
                console.error('預載失敗:', error);
                nextSong = null;
            } finally {
                isPreloading = false;
            }
        }

        async function setupNewGame() {
            isAnswerRevealed = false;
            answerSection.style.display = 'none';
            videoPlayerEl.style.display = 'none';
            videoPlayerEl.pause();
            videoPlayerEl.src = '';
            animeCoverEl.style.display = 'none';

            setStatus('正在準備歌曲...');
            revealBtn.disabled = true;
            nextSongBtn.disabled = true;
            submitGuessBtn.disabled = true;
            playBtns.forEach(btn => btn.disabled = true);

            answerInputs.forEach(input => {
                input.value = '';
                input.classList.remove('correct', 'incorrect');
                input.disabled = false;
            });

            if (playbackTimeout) clearTimeout(playbackTimeout);
            if (currentSong && currentSong.audioBlobUrl) URL.revokeObjectURL(currentSong.audioBlobUrl);
            audioPlayerEl.pause();

            if (!nextSong) await preloadNextSong();
            currentSong = nextSong;
            nextSong = null;

            if (!currentSong) {
                setStatus('載入歌曲失敗，請按下一首重試。', true);
                nextSongBtn.disabled = false;
                return;
            }

            const preloadPromise = preloadNextSong(); // 背景預載下一首
            audioPlayerEl.src = currentSong.audioBlobUrl;
            audioPlayerEl.load();

            audioPlayerEl.oncanplaythrough = async () => {
                setStatus('歌曲已就緒，請開始猜題！');
                revealBtn.disabled = false;
                submitGuessBtn.disabled = false;
                playBtns.forEach(btn => btn.disabled = false);
                await preloadPromise;
                nextSongBtn.disabled = false;
            };

            audioPlayerEl.onerror = () => {
                setStatus('音訊播放失敗，請按下一首跳過。', true);
                nextSongBtn.disabled = false;
            };
        }

        function checkAnswer() {
            if (isAnswerRevealed || !currentSong) return;
            const { metadata } = currentSong;
            let correctCount = 0;

            const nameCorrect = guessNameInput.value.trim() === metadata.anime_ch_name;
            guessNameInput.classList.toggle('correct', nameCorrect);
            guessNameInput.classList.toggle('incorrect', !nameCorrect);
            if (nameCorrect) correctCount++;

            const typeCorrect = guessTypeInput.value.trim().toUpperCase() === metadata.theme_type.toUpperCase();
            guessTypeInput.classList.toggle('correct', typeCorrect);
            guessTypeInput.classList.toggle('incorrect', !typeCorrect);
            if (typeCorrect) correctCount++;

            if (correctCount === 2) {
                setStatus('恭喜你，全部答對了！', false, true);
                revealAnswer();
            } else {
                setStatus(`答對了 ${correctCount} / 2 項。再試試看！`, correctCount === 0);
            }
        }
        
        function revealAnswer() {
            if (isAnswerRevealed || !currentSong) return;
            isAnswerRevealed = true;

            answerInputs.forEach(input => input.disabled = true);
            submitGuessBtn.disabled = true;
            revealBtn.disabled = true;
            if (playbackTimeout) clearTimeout(playbackTimeout);
            audioPlayerEl.pause();
            
            const { metadata } = currentSong;
            animeTitleEl.textContent = metadata.anime_ch_name;
            songInfoEl.textContent = `${metadata.theme_type}: ${metadata.theme_title}`;
            
            if (metadata.video_link) {
                videoPlayerEl.src = metadata.video_link;
                videoPlayerEl.style.display = 'block';
                videoPlayerEl.play();
            } else if (metadata.anime_img_url) {
                animeCoverEl.src = metadata.anime_img_url;
                animeCoverEl.style.display = 'block';
            }
            
            answerSection.style.display = 'block';
        }

        function playAudio(seconds, isRandom) {
            if (!currentSong) return;
            if (playbackTimeout) clearTimeout(playbackTimeout);
            
            let startTime = 0;
            if (isRandom && audioPlayerEl.duration) {
                const maxStartTime = audioPlayerEl.duration - seconds;
                startTime = Math.random() * (maxStartTime > 0 ? maxStartTime : 0);
            }
            
            audioPlayerEl.currentTime = startTime;
            audioPlayerEl.play();
            playbackTimeout = setTimeout(() => audioPlayerEl.pause(), seconds * 1000);
        }

        // --- 綁定事件 ---
        submitGuessBtn.addEventListener('click', checkAnswer);
        revealBtn.addEventListener('click', revealAnswer);
        nextSongBtn.addEventListener('click', setupNewGame);
        
        answerInputs.forEach(input => {
            input.addEventListener('keypress', e => { if (e.key === 'Enter') checkAnswer(); });
        });

        playBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const sec = parseInt(btn.getAttribute('data-sec'));
                const isRandom = btn.getAttribute('data-type') === 'random';
                playAudio(sec, isRandom);
            });
        });

        // --- 啟動第一局遊戲 ---
        if(gamePlaylist.length > 0) {
            setupNewGame();
        } else {
            setStatus("錯誤：找不到任何歌曲資料。", true);
        }
    });
    </script>
</body>
</html>