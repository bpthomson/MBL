<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Processing...</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body { overflow: hidden; }
        .gallery-container { width: 90%; height: 320px; display: flex; align-items: center; overflow-x: auto; background: #161b22; border-radius: 8px; padding: 0 20px; border: 1px solid #30363d; scroll-behavior: smooth; margin: 0 auto; }
        .gallery-container::-webkit-scrollbar { height: 6px; }
        .gallery-container::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
        
        .img-card { flex: 0 0 auto; width: 200px; margin-right: 20px; position: relative; background: #0d1117; border-radius: 6px; overflow: hidden; border: 1px solid #30363d; animation: slideInRight 0.4s ease-out forwards; }
        .img-card img { width: 100%; height: 280px; object-fit: cover; display: block; opacity: 0; animation: fadeIn 0.4s ease-out 0.1s forwards; filter: brightness(0.85); }
        .card-title { position: absolute; bottom: 0; width: 100%; background: rgba(13,17,23,0.9); color: #c9d1d9; font-size: 12px; padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box; border-top: 1px solid #30363d;}
        .status-tag { position: absolute; top: 0; width: 100%; background: rgba(218, 54, 51, 0.9); color: white; font-size: 10px; padding: 3px 0; text-align: center; display: none; font-family: monospace; }
        .img-card.low { border-color: #da3633; }
        .img-card.low .status-tag { display: block; }
        @keyframes slideInRight { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/" class="navbar-brand">
            <span style="color: #005bb5; font-weight: bold; margin-right: 5px;">/></span>MBL System
        </a>
        
        <div class="navbar-links" style="display: flex; align-items: center; gap: 15px;">
            <span style="display: flex; align-items: center; gap: 5px; color: #3fb950; font-family: monospace; font-size: 11px;">
                <span style="width: 6px; height: 6px; background-color: #3fb950; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #3fb950;"></span>
                SYS.ONLINE
            </span>

            {% if user_id %}
            <span style="color: #8b949e; font-family: monospace; font-size: 11px; border-left: 1px solid #30363d; padding-left: 15px;">
                TARGET : <span style="color: #c9d1d9;">{{ user_id }}</span>
            </span>
            {% endif %}

            <span style="border-left: 1px solid #30363d; padding-left: 15px;">
                <a href="https://docs.google.com/spreadsheets/d/14lacBmNveOxbD461wObB9x0KW86dFY4GgsTbte8iOo8/edit" target="_blank">[ Error Logs ]</a>
            </span>
        </div>
    </div>
    <div style="text-align: center; margin: 30px 0;">
        <div class="loader" style="margin: 0 auto 15px auto;"></div>
        <h2 id="st" style="font-size: 16px; font-weight: 500; color: #c9d1d9; margin: 0 0 5px 0;">Establishing Connection...</h2>
        <div id="cnt" style="font-size: 13px; color: #8b949e; font-family: monospace;">Awaiting data stream</div>
    </div>
    <div class="gallery-container" id="gal"></div>

<script>
const es = new EventSource("/stream_progress?user_id={{user_id}}&limit={{limit}}");
let done = false;
const gal = document.getElementById('gal');
const st = document.getElementById('st');
const cnt = document.getElementById('cnt');

es.onmessage = e => {
    if(done) return;
    const d = JSON.parse(e.data);
    if(d.error) { st.innerText = `ERR: ${d.error}`; st.style.color = "#ff7b72"; es.close(); done = true; return; }
    if(d.done) {
        st.innerText = "Task Completed. Redirecting..."; st.style.color = "#3fb950"; es.close(); done = true;
        setTimeout(() => window.location.href = d.redirect_url, 1000); return;
    }
    if(d.msg) st.innerText = d.msg;
    if(d.type === 'image') {
        cnt.innerText = `[ ${d.current} / ${d.total} ]`;
        const isAtRightEnd = (gal.scrollWidth - gal.scrollLeft - gal.clientWidth) < 50;
        const c = document.createElement('div');
        c.className = 'img-card ' + (d.is_low ? 'low' : '');
        const statusText = d.status.includes('Low') ? 'WARN: Low Accuracy' : d.status;
        c.innerHTML = `<div class="status-tag">${statusText}</div><img src="${d.img_url}"><div class="card-title">${d.title}</div>`;
        gal.appendChild(c);
        if (isAtRightEnd) { setTimeout(() => { gal.scrollTo({ left: gal.scrollWidth, behavior: 'smooth' }); }, 50); }
    }
};
es.onerror = () => { if(!done) es.close(); }
</script>
</body>
</html>