<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"><title>處理中</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; background: #121212; color: #e0e0e0; margin: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
    
    .loader { border: 3px solid #333; border-top: 3px solid #0071e3; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .status-area { text-align: center; margin-bottom: 20px; }
    .status { font-size: 18px; font-weight: 500; color: #fff; margin-bottom: 5px; }
    .count { font-size: 14px; color: #888; font-family: monospace; }
    
    .gallery-container { width: 90%; height: 320px; display: flex; align-items: center; overflow-x: auto; background: #1e1e1e; border-radius: 12px; padding: 0 20px; border: 1px solid #333; scroll-behavior: smooth; }
    .gallery-container::-webkit-scrollbar { height: 8px; }
    .gallery-container::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    .gallery-container::-webkit-scrollbar-track { background: #1e1e1e; }

    .card { flex: 0 0 auto; width: 200px; margin-right: 20px; position: relative; background: #000; border-radius: 8px; overflow: hidden; border: 2px solid transparent; animation: slideInRight 0.5s ease-out forwards; }
    .card img { width: 100%; height: 280px; object-fit: cover; display: block; opacity: 0; animation: fadeIn 0.5s ease-out 0.2s forwards; }
    .card-title { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.85); color: #fff; font-size: 12px; padding: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-sizing: border-box; }
    
    .status-tag { position: absolute; top: 0; width: 100%; background: rgba(255, 69, 58, 0.9); color: white; font-size: 10px; padding: 2px 0; text-align: center; display: none; }
    .card.low { border-color: #ff453a; }
    .card.low .status-tag { display: block; }

    @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { to { opacity: 1; } }
</style>
</head>
<body>
    <div class="loader"></div>
    <div class="status-area">
        <div class="status" id="st">初始化連線...</div>
        <div class="count" id="cnt">等待資料</div>
    </div>
    <div class="gallery-container" id="gal"></div>

<script>
const es = new EventSource("/stream_progress?user_id={{user_id}}&limit={{limit}}");
let done = false;
const gal = document.getElementById('gal');
const st = document.getElementById('st');
const cnt = document.getElementById('cnt');

es.onmessage = e => {
    if(done) return;
    const d = JSON.parse(e.data);
    
    if(d.error) {
        st.innerText = d.error;
        st.style.color = "#ff453a";
        es.close(); done = true; return;
    }
    
    if(d.done) {
        st.innerText = "配對完成，準備跳轉";
        st.style.color = "#32d74b";
        es.close(); done = true;
        setTimeout(() => window.location.href = d.redirect_url, 1000);
        return;
    }
    
    if(d.msg) st.innerText = d.msg;
    
    if(d.type === 'image') {
        cnt.innerText = `${d.current} / ${d.total}`;

        const isAtRightEnd = (gal.scrollWidth - gal.scrollLeft - gal.clientWidth) < 50;

        const c = document.createElement('div');
        c.className = 'card ' + (d.is_low ? 'low' : '');
        c.innerHTML = `<div class="status-tag">${d.status}</div><img src="${d.img_url}"><div class="card-title">${d.title}</div>`;
        gal.appendChild(c);
        
        if (isAtRightEnd) {
            setTimeout(() => { gal.scrollTo({ left: gal.scrollWidth, behavior: 'smooth' }); }, 50); 
        }
    }
};
es.onerror = () => { if(!done) es.close(); }
</script>
</body>
</html>