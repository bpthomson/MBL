<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"><title>處理中</title>
<style>
body{font-family:sans-serif;background:#1a1a1a;color:#fff;margin:0;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
.loader{border:4px solid #333;border-top:4px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.gallery-container{width:90%;height:320px;display:flex;align-items:center;overflow-x:auto;background:rgba(255,255,255,0.05);border-radius:15px;padding:0 20px;border:1px solid #333;scroll-behavior:smooth}
.anime-card{flex:0 0 auto;width:200px;margin-right:20px;position:relative;animation:slideIn 0.5s ease-out;background:#000;border-radius:8px;overflow:hidden}
.anime-card img{width:100%;height:280px;object-fit:cover;display:block}
.anime-card .title{position:absolute;bottom:0;width:100%;background:rgba(0,0,0,0.7);font-size:12px;padding:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.anime-card.low-conf{box-shadow:0 0 0 4px #ff3333;transform:scale(0.95)}
@keyframes slideIn{from{opacity:0;transform:translateX(50px) scale(0.8)}to{opacity:1;transform:translateX(0) scale(1)}}
</style>
</head>
<body>
<div style="text-align:center;z-index:10;margin-bottom:20px">
    <div class="loader"></div>
    <div id="status">準備中...</div>
</div>
<div class="gallery-container" id="gallery"></div>

<script>
// 注意：這裡是連接 /stream_progress (爬蟲進度)
const es = new EventSource("/stream_progress?user_id={{user_id}}&limit={{limit}}");
let done = false;

es.onmessage = e => {
    if(done) return;
    const d = JSON.parse(e.data);
    
    if(d.error){
        document.getElementById('status').innerText = d.error;
        document.getElementById('status').style.color = "red";
        es.close();
        done = true;
        return;
    }
    
    if(d.done){
        document.getElementById('status').innerText = "完成！跳轉中...";
        es.close();
        done = true;
        setTimeout(() => window.location.href = d.redirect_url, 1000);
        return;
    }
    
    if(d.msg) document.getElementById('status').innerText = d.msg;
    
    if(d.type === 'image'){
        const c = document.createElement('div');
        c.className = 'anime-card ' + (d.is_low ? 'low-conf' : '');
        c.innerHTML = `<img src="${d.img_url}"><div class="title">${d.title}</div>`;
        document.getElementById('gallery').appendChild(c);
        requestAnimationFrame(() => document.getElementById('gallery').scrollLeft = document.getElementById('gallery').scrollWidth);
    }
};

es.onerror = () => {
    if(!done) es.close();
}
</script>
</body>
</html>