<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>é¸æ“‡é …ç›®</title>
<style>
body{font-family:sans-serif;background:#f4f4f4;padding:20px}
.controls{position:sticky;top:0;z-index:90;background:#fff;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center;border-radius:8px;margin-bottom:20px}
.btn{padding:8px 16px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;margin-left:5px}
.btn-primary{background:#007bff;color:#fff} .btn-music{background:#6610f2;color:#fff} .btn-outline{border:1px solid #666;background:none}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px}
.card-wrapper{position:relative;transition:transform 0.2s}
.card-wrapper:hover{transform:translateY(-5px);z-index:50}
.card{background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1);border:3px solid transparent;transition:box-shadow 0.2s,border-color 0.2s;display:block;height:100%}
.card:hover{box-shadow:0 5px 15px rgba(0,0,0,.2)}
.card.selected{border-color:#007bff}
.card.selected::after{content:"âœ”";position:absolute;top:5px;right:5px;background:#007bff;color:#fff;border-radius:50%;width:24px;line-height:24px;text-align:center}
.card.warning{border-color:#ffc107}
.card img{width:100%;height:250px;object-fit:cover;display:block}
.card-body{padding:10px;padding-bottom:45px}
.report-btn{position:absolute;bottom:8px;right:8px;background:#dc3545;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;z-index:20;opacity:0.9;transition:0.2s}
.report-btn:hover{transform:scale(1.1);opacity:1} .report-btn.reported{background:#6c757d;cursor:default}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
.modal{background:#fff;padding:20px;border-radius:8px;width:300px;text-align:center}
input[type=checkbox]{display:none}
</style></head>
<body>
<form action="/dispatch_action" method="POST">
<input type="hidden" name="user_id" value="{{user_id}}">
<div class="controls">
 <div><h2>ç¯©é¸</h2><span style="color:#666;font-size:12px">ç¢ºèªç„¡èª¤å¾Œé¸æ“‡åŠŸèƒ½</span></div>
 <div>
  <button type="button" class="btn btn-outline" onclick="toggle(true)">å…¨é¸</button>
  <button type="button" class="btn btn-outline" onclick="toggle(false)">å…¨æ¶ˆ</button>
  <button type="submit" name="action" value="xml" class="btn btn-primary">ğŸ“„ ç”Ÿæˆ XML</button>
  <button type="submit" name="action" value="music" class="btn btn-music">ğŸµ ä¸‹è¼‰éŸ³æ¨‚</button>
 </div>
</div>
<div class="grid">
{% for item in results %}
<div class="card-wrapper">
 <label class="card {% if item.mal_id and not item.is_low %}selected{% endif %} {% if item.is_low %}warning{% endif %}">
  <input type="checkbox" name="selected_items" value="{{item.id}}" {% if item.mal_id and not item.is_low %}checked{% endif %} onchange="upd(this)">
  <img src="{{item.img_url}}" loading="lazy">
  <div class="card-body"><b>{{item.baha_title}}</b><br><small style="color:#666">{{item.mal_title}}</small></div>
 </label>
 <button type="button" class="report-btn" id="btn-{{item.id}}" onclick="openRep('{{item.id}}','{{item.baha_title}}')">å›å ±</button>
</div>
{% endfor %}
</div>
</form>

<div class="modal-overlay" id="repModal"><div class="modal">
<h3>å›å ±éŒ¯èª¤</h3><p id="mTitle" style="color:#007bff"></p>
<input type="text" id="mMsg" placeholder="æ­£ç¢ºIDæˆ–å‚™è¨»" style="width:90%;padding:5px;margin:10px 0">
<br><button onclick="subRep()">é€å‡º</button> <button onclick="clsRep()">å–æ¶ˆ</button>
</div></div>

<script>
let curId=null;
const uid="{{user_id}}";
function upd(cb){cb.closest('.card').classList.toggle('selected',cb.checked)}
function toggle(v){document.querySelectorAll('input[type=checkbox]').forEach(c=>{c.checked=v;upd(c)})}
function openRep(id,t){if(document.getElementById('btn-'+id).classList.contains('reported'))return;curId=id;document.getElementById('mTitle').innerText=t;document.getElementById('mMsg').value='';document.getElementById('repModal').style.display='flex'}
function clsRep(){document.getElementById('repModal').style.display='none';curId=null}
function subRep(){
 const msg=document.getElementById('mMsg').value; if(!msg)return;
 fetch('/report_match',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:uid,item_id:curId,message:msg})})
 .then(r=>r.json()).then(d=>{if(d.success){const b=document.getElementById('btn-'+curId);b.innerText="å·²å›å ±";b.classList.add('reported');clsRep()}else alert('å¤±æ•—')});
}
</script></body></html>