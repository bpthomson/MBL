<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Audio Processing</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="flex-center">
    <div class="navbar">
        <a href="/" class="navbar-brand">
            <span style="color: #005bb5; font-weight: bold; margin-right: 5px;">/></span>MBL System
        </a>
        
        <div class="navbar-links" style="display: flex; align-items: center; gap: 15px;">
            <span style="display: flex; align-items: center; gap: 5px; color: #3fb950; font-family: monospace; font-size: 11px;">
                <span style="width: 6px; height: 6px; background-color: #3fb950; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #3fb950;"></span>
                SYS.ONLINE
            </span>

            {% if user_id %}
            <span style="color: #8b949e; font-family: monospace; font-size: 11px; border-left: 1px solid #30363d; padding-left: 15px;">
                TARGET : <span style="color: #c9d1d9;">{{ user_id }}</span>
            </span>
            {% endif %}

            <span style="border-left: 1px solid #30363d; padding-left: 15px;">
                <a href="https://docs.google.com/spreadsheets/d/14lacBmNveOxbD461wObB9x0KW86dFY4GgsTbte8iOo8/edit" target="_blank">[ Error Logs ]</a>
            </span>
        </div>
    </div>
    <div class="navbar">
        <a href="/" class="navbar-brand">MBL System</a>
        <div class="navbar-links">
            <a href="/">[ Terminate Session ]</a>
        </div>
    </div>

    <div class="wrapper">
        <div class="header-section col">
            <h1 id="status">Compiling Audio Archive...</h1>
            <p class="sub-text">Please wait. Processing data stream.</p>
        </div>
        <div class="progress-bg"><div class="progress-fill" id="fill"></div></div>
        <div class="log-window" id="log"></div>

        <div class="main-actions" id="action-area" style="display: none; margin-top: 20px;">
            <a href="#" id="dlBtn" class="btn btn-primary" style="flex: 1; text-decoration: none;">Download Archive</a>
            <a href="/select/{{user_id}}" class="btn btn-secondary" style="flex: 1; text-decoration: none;">Return</a>
        </div>
    </div>

<script>
const es = new EventSource("/stream_music_download?user_id={{user_id}}");
const log = document.getElementById('log');
const status = document.getElementById('status');

function addLog(txt) {
    const d = document.createElement('div');
    d.className = 'log-line'; d.innerText = `> ${txt}`;
    log.appendChild(d); log.scrollTop = log.scrollHeight;
}

es.onmessage = e => {
    const d = JSON.parse(e.data);
    if(d.error) { 
        status.innerText = "System Error"; 
        addLog("SYS_ERR: " + d.error); 
        document.getElementById('action-area').style.display = 'flex';
        document.getElementById('dlBtn').style.display = 'none';
        es.close(); return; 
    }
    if(d.msg) { status.innerText = d.msg; addLog(d.msg); }
    if(d.progress) document.getElementById('fill').style.width = d.progress;
    
    if(d.done) {
        status.innerText = "Archive Ready.";
        status.classList.add('text-success');
        
        document.getElementById('dlBtn').href = "/download/" + d.filename;
        document.getElementById('action-area').style.display = 'flex';
        es.close();
    }
};
</script>
</body>
</html>