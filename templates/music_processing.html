<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><title>下載中</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .container { width: 90%; max-width: 600px; }
        h2 { font-weight: 500; margin-bottom: 20px; text-align: center; color: #fff; }
        .progress-bg { width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; width: 0%; background: #0071e3; transition: width 0.3s; }
        .log-window { height: 250px; background: #000; border: 1px solid #333; padding: 15px; overflow-y: auto; font-size: 12px; line-height: 1.6; color: #aaa; border-radius: 6px; margin-bottom: 20px; }
        .log-line { border-bottom: 1px solid #1a1a1a; padding: 2px 0; }
        .btn-area { text-align: center; display: flex; justify-content: center; gap: 15px; }
        .btn-area a { display: none; }
    </style>
</head>
<body class="flex-center">
<div class="container">
    <h2 id="status">下載中...</h2>
    <div class="progress-bg"><div class="progress-fill" id="fill"></div></div>
    <div class="log-window" id="log"></div>
    <div class="btn-area">
        <a href="#" id="dlBtn" class="btn btn-primary">下載檔案</a>
        <a href="/select/{{user_id}}" id="backBtn" class="btn btn-secondary">返回清單</a>
    </div>
</div>
<script>
const es = new EventSource("/stream_music_download?user_id={{user_id}}");
const log = document.getElementById('log');
const status = document.getElementById('status');

function addLog(txt) {
    const d = document.createElement('div');
    d.className = 'log-line'; d.innerText = txt;
    log.appendChild(d); log.scrollTop = log.scrollHeight;
}

es.onmessage = e => {
    const d = JSON.parse(e.data);
    if(d.error) { status.innerText="錯誤"; addLog("Error: "+d.error); document.getElementById('backBtn').style.display='inline-block'; es.close(); return; }
    if(d.msg) { document.getElementById('status').innerText = d.msg; addLog(d.msg); }
    if(d.progress) document.getElementById('fill').style.width = d.progress;
    if(d.done) {
        status.innerText = "打包完成";
        document.getElementById('dlBtn').href = "/download/"+d.filename;
        document.getElementById('dlBtn').style.display = 'inline-block';
        document.getElementById('backBtn').style.display = 'inline-block';
        es.close();
    }
};
</script>
</body>
</html>